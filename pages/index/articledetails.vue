<template>
	<view class="detail-wrap bt-1px">
		<u-navbar :autoBack="true">
			<view slot="center">
				<view class="top-title">
					<text class="numlist-img">
						<svg width="26" height="25" viewBox="0 0 26 25" fill="none" xmlns="http://www.w3.org/2000/svg">
							<path
								d="M20.3162 24.2404C20.9908 25.1915 21.47 24.8709 21.47 24.8709C22.9221 24.4638 22.7738 21.571 22.7738 21.571C22.5876 18.1216 20.7629 15.5998 20.7629 15.5998L16.8912 15.7475L14.2708 20.5443L14.1298 20.6703C14.1533 20.6703 14.1768 20.6721 14.2003 20.6739L14.137 20.791C14.5149 20.7478 14.8748 20.7442 15.2112 20.7676C16.8514 21.009 17.8496 21.6304 18.4229 22.0879C19.2728 22.7688 19.9039 23.655 20.318 24.2386L20.3162 24.2404Z"
								fill="url(#paint0_linear_251_584)" />
							<path
								d="M16.8677 7.68324C17.638 7.97505 19.2602 8.0507 20.8949 7.65262C20.9094 7.64902 20.9239 7.64542 20.9383 7.64361C21.1174 7.6166 22.5098 7.38243 24.2766 6.31428C24.3652 6.26205 24.4647 6.22962 24.566 6.22602C24.9168 6.21521 25.5967 6.39354 25.1537 8.07051C24.5732 10.2663 22.839 13.9192 20.8298 16.0159C20.8136 16.0339 20.7973 16.0519 20.7828 16.0717C20.5658 16.3707 18.3433 19.2383 10.0754 23.5938C10.0754 23.5938 7.42249 25.1122 5.74793 24.5791C5.16925 24.3953 4.83651 23.7883 5.01735 23.2083C5.10234 22.9309 5.2669 22.6031 5.56709 22.2392C5.56709 22.2392 7.52919 19.667 7.64492 16.2735C7.64673 16.205 7.6612 16.1366 7.68652 16.0735L8.98674 12.8006C9.03738 12.6727 9.13142 12.5647 9.25258 12.498L11.7084 11.1309L16.1299 8.474C16.3053 8.36772 16.4138 8.18219 16.421 7.97685C16.4282 7.72107 16.629 7.59138 16.8695 7.68144L16.8677 7.68324Z"
								fill="url(#paint1_linear_251_584)" />
							<path
								d="M15.1859 5.20828C15.1859 5.20828 18.0865 8.69733 18.0865 10.2518C18.0865 10.2518 18.2565 12.4836 14.8278 12.552C14.8278 12.552 10.0067 13.3302 9.53107 13.8705C9.53107 13.8705 7.96863 14.5136 7.63046 16.6427C7.63046 16.6427 7.48579 15.0306 5.96855 14.4614C5.75878 14.3839 5.53816 14.3425 5.31573 14.3317C4.43505 14.2956 1.44398 14.1732 1.21432 14.1732C0.943059 14.1732 -0.0750607 14.1047 0.943059 12.9897C1.96118 11.8747 5.97398 9.07019 10.3087 8.89727L10.8096 8.65409L13.9761 6.29985L15.1859 5.20648V5.20828Z"
								fill="url(#paint2_linear_251_584)" />
							<path
								d="M10.7607 1.68141C11.2797 1.80389 12.7536 2.40371 15.2744 5.31095C15.2744 5.31095 17.3396 8.20557 12.9489 8.74955C12.9489 8.74955 9.42252 8.82341 6.79675 9.57093C6.79675 9.57093 9.09882 8.82701 9.51114 5.98462C9.57262 5.56493 9.57081 5.13983 9.52922 4.71833C9.44965 3.90236 9.36827 1.99122 10.3249 1.68861C10.466 1.64358 10.6179 1.64718 10.7625 1.68141H10.7607Z"
								fill="url(#paint3_linear_251_584)" />
							<path
								d="M12.0067 4.29866C12.5541 4.29866 12.9977 3.54301 12.9977 2.61088C12.9977 1.67874 12.5541 0.923096 12.0067 0.923096C11.4594 0.923096 11.0157 1.67874 11.0157 2.61088C11.0157 3.54301 11.4594 4.29866 12.0067 4.29866Z"
								fill="black" />
							<path
								d="M12.2346 3.89697C12.656 3.89697 12.9977 3.32116 12.9977 2.61087C12.9977 1.90057 12.656 1.32477 12.2346 1.32477C11.8131 1.32477 11.4714 1.90057 11.4714 2.61087C11.4714 3.32116 11.8131 3.89697 12.2346 3.89697Z"
								fill="white" />
							<path
								d="M12.4787 3.12605C12.7654 3.12605 12.9977 2.81154 12.9977 2.42356C12.9977 2.03559 12.7654 1.72107 12.4787 1.72107C12.1921 1.72107 11.9597 2.03559 11.9597 2.42356C11.9597 2.81154 12.1921 3.12605 12.4787 3.12605Z"
								fill="black" />
							<path
								d="M11.0012 7.08342C11.0012 7.08342 13.1912 6.96274 14.9417 4.22662C14.9417 4.22662 13.3594 9.57817 11.0012 7.08342Z"
								fill="white" />
							<path
								d="M12.4714 7.44366C12.2617 7.47608 12.0428 7.41664 11.8186 7.26353C12.2834 7.13384 13.032 6.82403 13.8006 6.08911C13.4534 6.74477 12.9904 7.3626 12.4714 7.44366Z"
								fill="#FF9C9C" />
							<path
								d="M12.249 7.84172C11.8078 7.84172 11.3123 7.55893 10.8765 7.09961L11.1134 7.06898C11.5962 7.57874 12.0338 7.73005 12.5004 7.61837C13.6397 7.34638 14.316 5.26592 14.7374 4.5256C14.8748 4.28423 14.9399 4.22479 14.9399 4.22479C14.9019 4.35448 14.0737 7.44184 12.5456 7.8057C12.4461 7.82912 12.3467 7.84172 12.249 7.84172Z"
								fill="black" />
							<defs>
								<linearGradient id="paint0_linear_251_584" x1="15.911" y1="16.9291" x2="23.2728"
									y2="23.0387" gradientUnits="userSpaceOnUse">
									<stop stop-color="#0070FF" />
									<stop offset="1" stop-color="#1BD8DE" />
								</linearGradient>
								<linearGradient id="paint1_linear_251_584" x1="4.96852" y1="15.4611" x2="25.3002"
									y2="15.4611" gradientUnits="userSpaceOnUse">
									<stop stop-color="#2F4AF9" />
									<stop offset="1" stop-color="#FF00FD" />
								</linearGradient>
								<linearGradient id="paint2_linear_251_584" x1="6.66478" y1="13.7715" x2="21.2229"
									y2="4.73179" gradientUnits="userSpaceOnUse">
									<stop stop-color="#2F4AF9" />
									<stop offset="1" stop-color="#FF00FD" />
								</linearGradient>
								<linearGradient id="paint3_linear_251_584" x1="6.79494" y1="5.61356" x2="15.7591"
									y2="5.61356" gradientUnits="userSpaceOnUse">
									<stop stop-color="#0070FF" />
									<stop offset="1" stop-color="#1BD8DE" />
								</linearGradient>
							</defs>
						</svg>
					</text>
					<text class="numlist-name">{{logoName}}</text>
				</view>
			</view>
		</u-navbar>
		<view class="title" v-if="lang!='short'&&detail.title">{{detail.title}}</view>
		<!-- <view class="information flex-between">
			<view class="left flex-middle">
				<block v-if="type==2">
					<image v-if="detail.member&&detail.member.avatar" :src="detail.member.avatar" mode=""></image>
					<image v-else :src="IMG_URL+'avatar.png'" mode=""></image>
				</block>
				<block v-if="type==1">
					<image :src="IMG_URL+'avatar.png'" mode=""></image>
				</block>
				<view class="names">
					<block v-if="type==1">
						<view class="name">{{detail.author}}</view>
					</block>
					<block v-else>
						<view class="name" v-if="detail.member&&detail.member.nickname">{{detail.member.nickname}}
						</view>
					</block>
					<view class="time">{{detail.created_at}} &nbsp;&nbsp;{{detail.read}}阅读</view>
				</view>
			</view>
			<view class="right" v-if="type==2&&detail.belongs_to=='others'">
				<image v-if="detail.is_follow==0" :src="IMG_URL+'follow.png'" mode="" @click="is_followMemberhandle()">
				</image>
				<image v-else :src="IMG_URL+'follow_true.png'" mode="" @click="is_followMemberhandle()"></image>
			</view>
		</view> -->
		<view class="name-date">
			<text>
				<text v-if="type==1">{{detail.author}}</text>
				<text v-else>{{detail &&detail.member && detail.member.nickname}}</text>
			</text>
			<text>|</text>
			<text class="date">{{detail.created_at}}</text>
			<text>|</text>
			<text>{{detail.read}}阅读</text>
		</view>

		<view class="content">
			<mp-html class="tips" :content="detail.content"></mp-html>
		</view>
		<view class="images flex-between" v-if="detail.image_text&&detail.image_text.length>0 && type == '2'">
			<image v-for="(items,indexs) in detail.image_text" :key="indexs" :src="items"></image>
			<!-- <view style="width: 210rpx;"></view> -->
		</view>

		<!-- 精选推荐 -->
		<view class="hot" v-if="this.recommendList != ''">
			<view class="hot-name">
				精选推荐
			</view>
			<view class="hot-item">
				<view class="item-box flex-between" v-for="(item, index) in recommendList.slice(0,4)" :key="index"
					@click="dianji(item)">
					<view class="item-left">
						<view class="item-left-title much-ell-two">
							{{ item.title }}
						</view>
						<view class="item-left-ping flex-middle">
							<text>{{item.comments || '0'}}评论</text>
							<text class="t1">{{item.updated_at}}</text>
						</view>
					</view>
					<view class="item-right" v-if="item.image">
						<image :src="item.image[0] ? item.image[0] : item.image " mode="scaleToFill"></image>
						<!-- <image src="" mode="" v-else></image> -->
					</view>
				</view>
			</view>
		</view>


		<view class="stickyScrollTop">
			<u-loading-page :loading="pageLoading"></u-loading-page>
			<block v-if="!pageLoading">
				<comment :commentlist="commentlist" @commenthandle="commenthandle" @handlepinglun="handlepinglun"
					@integralhandle="integralhandle" :type="type" :detail="detail"></comment>
			</block>
		</view>
		<sharemodel :sharemode="sharemode" :url="sharemodeurl" @handleclose="handleclose" :shareid="id"
			@integralhandles="integralhandles" :sharetype="type" :detail="detail" @onChange="onChange"
			:tabsactivetop="tabsactivetop"></sharemodel>
		<isintegral :inputmode="inputmode" :integramessage="integramessage" :integramessagedata="integramessagedata"
			@tozizhihandle="tozizhihandle"></isintegral>
		<!-- 登录提示 -->
		<login-modal></login-modal>
		<view class="post" v-show="tishi==1">
			<p style="color: #fff;font-size: 30upx;margin-top: 10upx;">长按保存图片至相册</p>
			<view class="content" style="text-align: center;width: 90%;margin: 0 10px;">
				<view style="margin-top: 30upx;background: #fff;">
					<view style="background: #fff;">
						<img id="test" style="width: 100%;height: 400upx;" />
						<!-- <img id="test" style="width: 580upx;height: 954upx;"/> -->

						<view class="artictitle">{{detail.title}}</view>
						<mp-html class="articcontent" :content="detail.content"></mp-html>
						<!-- <view id="content" class="articcontent" v-html="detail.cont"></view> -->
						<view id="tip" style="display: flex;">

							<view v-for="(item,index) in detail.tag" :key="index" class="tip1">{{item.name}}</view>
						</view>
						<view class="bottom">
							<view class="left">
								<view class="top">扫码进入Defam</view>
								<view class="top">阅读更多深度内容</view>
							</view>
							<view class="right">
								<image src="../../static/images/codeImg.png"
									style="width: 50px;height: 50px;text-align: right;"></image>
							</view>
						</view>
					</view>
				</view>
			</view>
			<!-- #ifdef APP-PLUS -->
			<image @click="guanbi" class="cha" style="width: 80upx;height: 80upx; margin-top: 25upx;margin-left: 47%;">
			</image>
			<!-- #endif -->
			<!-- #ifdef H5 -->
			<image @click="guanbi" class="cha" style="width: 80upx;height: 80upx; margin-top: 25upx; margin: 0;">
			</image>
			<!-- #endif -->
		</view>
		<!-- </view> -->
	</view>
</template>

<script>
	import canvas_x from "../../components/mg-h5hb/common/canvas_x.js"
	import MpHtml from '@/components/mp-html/mp-html'
	import comment from './components/comment.vue'
	import sharemodel from './components/sharemodel.vue'
	import {
		userInfo
	} from '@/engine/storage';
	import isintegral from '@/components/common/is_integral.vue';
	export default {
		components: {
			MpHtml,
			comment,
			sharemodel,
			isintegral
		},
		data() {
			return {
				IMG_URL: this.$IMG_URL,
				detail: {},
				commentinfo: {},
				type: 0,
				sharemode: false,
				id: '',
				commentlist: [],
				hasNext: false,
				page: 1,
				loadStatus: 'loadmore',
				pageLoading: true,
				sharemodeurl: '',
				inputmode: false,
				integramessage: '',
				integramessagedata: {},
				recommendList: [], // 精选推荐列表,



				tishi: 0,
				userid: 0,
				img: "",
				phone: "",
				poster: {},
				qrShow: false,
				canvasId: 'default_PosterCanvasId',
				nickname: "",
				val: "",
				detail: '',
				title: '',
				articContent: '',
				tags: [],
				content: '',
				tabsactivetop: '',
				logo: '',
				logoName: ''
			}
		},
		onLoad() {
			this.$http('config', {
				module: 'basic'
			}, 'get').then((res) => {
				this.logo = res.data.logo
				this.logoName = res.data.name
			}).catch(() => {})
			this.tabsactivetop = this.$Route.query.tabsactivetop
			console.log('888', this.tabsactivetop)
			this.type = this.$Route.query.type || '' //类型1资讯 2文章 3活动 4.帖子
			this.lang = this.$Route.query.lang || '' //长文还是短文


			try {
				this.id = this.$Route.query.id;
				this.detailhandle()
				this.commentlisthandle()
				this.getRecommend()
			} catch (e) {
				//TODO handle the exception
			}

		},
		onPullDownRefresh() {
			this.page = 1;
			this.commentlisthandle();
			this.detailhandle();
		},
		onReachBottom() {
			if (this.hasNext) {
				this.page++;
				this.commentlisthandle();
			}
		},
		onShareAppMessage(res) {
			this.$http('member/forward', {
				action_id: this.id,
				type: this.type
			}, 'get').then(res => {}).catch(() => {})
		},
		methods: {
			dianji(item) {
				// console.log(item)
				this.$Router.replace({
					path: '/pages/index/articledetails',
					query: {
						id: item.id,
						type: 1,
					}
				})
				this.reload()
			},
			// 获取资讯精选推荐列表
			getRecommend() {
				this.$http('realinfo/recommend_list', {}, 'get').then(res => {
					console.log(res)
					this.recommendList = res.data.data;
				}).catch(() => {})
			},
			// 资讯详情realinfo/read?id=3
			//文章or帖子详情article/read?id=1
			detailhandle() {
				let url = ''
				if (this.type == 1) {
					url = 'realinfo/read'
				} else if (this.type == 2) {
					url = 'article/read'
				}
				uni.showLoading()
				this.$http(url, {
					id: this.id
				}, 'get').then(res => {
					uni.hideLoading()
					uni.stopPullDownRefresh();
					this.detail = res.data
					if (res.data) {
						uni.setNavigationBarTitle({
							title: res.data.title
						})
					}
					this.sharemodeurl = 'pages/index/articledetails?type=' + this.type + '&lang=' + this.detail
						.type + '&id=' + this.detail.id
					setTimeout(() => {
						this.pageLoading = false
					}, 100)
				})
			},
			//评论列表comment?id=1&type=2
			commentlisthandle() {
				uni.showLoading()
				this.$http('comment', {
					page: this.page,
					id: this.id,
					type: this.type
				}, 'get').then(res => {
					uni.hideLoading()
					uni.stopPullDownRefresh();
					let newData = res.data;
					this.page = newData.current_page;
					this.hasNext = newData.last_page > newData.current_page;
					this.loadStatus = this.hasNext ? 'loadmore' : 'nomore';
					this.commentlist = this.page == 1 ? newData.data : [...this.commentlist, ...newData.data];
				}).catch(() => {})
			},
			//关注或取消关注memberfollow/is_followMember?to_member_id=2&type=
			is_followMemberhandle() {
				userInfo.get(true).then(res => {
					uni.showLoading()
					this.$http('memberfollow/is_followMember', {
						to_member_id: this.detail.member_id,
						member_id: res.id,
						type: 1
					}, 'get').then(res => {
						uni.hideLoading()
						let _this = this
						setTimeout(() => {
							_this.$u.toast(res.message)
						})
						this.detailhandle()
					}).catch(() => {})
				})
			},
			//评论返回
			commenthandle(e) {
				if (e.pinglun) {
					this.page = 1;
					this.commentlisthandle()
					this.detailhandle()
				} else if (e.dianzan) {
					this.detailhandle()
				} else if (e.share) {
					this.sharemode = e.share
				}
			},
			//分享取消
			handleclose(e) {
				this.sharemode = e
				this.detailhandle()
			},
			//跳转到评论的位置
			handlepinglun() {
				uni.createSelectorQuery().select('.stickyScrollTop').boundingClientRect(res => {
					//这里会获取到选择器中元素距离顶部的距离，以便后续定位或吸顶效果实现
					uni.pageScrollTo({
						scrollTop: res.top,
						duration: 0,
					})
				}).exec();
			},
			integralhandle(e) {
				this.inputmode = e.inputmode
				this.integramessage = e.message
				this.integramessagedata = e.messagedata
			},
			tozizhihandle(e) {
				this.inputmode = e
			},
			integralhandles(e) {
				this.integralhandle(e)
			},

			guanbi: function() {
				this.tishi = 0;

			},
			erweima: function() {
				this.tishi = 1;
				canvas_x.makeImage({
					type: 'url',
					parts: [{
							type: 'image',
							url: '../../static/images/headImg.png',
							width: 680,
							height: 1264,
							// backgroundSize:680,
						},
						// {
						// 	type: 'qrcode',
						// 	text: this.val,
						// 	x: 80,
						// 	y: -50,
						// 	width: 130,
						// 	height: 130,
						// 	padding: 0,
						// 	background: '#fff',
						// 	level: 3
						// },
						//  {
						// 	type: 'text',
						// 	text: this.title,
						// 	textAlign: 'left',
						// 	lineAlign: 'TOP',
						// 	x: 440,
						// 	y: 300,
						// 	color: 'black',
						// 	size: '30px',
						// 	// bold: true
						// },
						// {
						// 	type: 'text',
						// 	text:'玫瑰',
						// 	textAlign: 'left',
						// 	lineAlign: 'TOP',
						// 	x: 440,
						// 	y: 1185,
						// 	color: 'black',
						// 	size: '30px',
						// 	// bold: true
						// }
					],
					width: 680,
					height: 1264
				}, (err, data) => {
					document.getElementById('test').src = data
				})
			},
			//监听保存图片的额点击事件
			onChange(val) {
				console.log('88888888', val)
				this.erweima()
			}
		}
	}
</script>

<style lang="scss" scoped>
	.tips {
		line-height: 2;
		color: #080F18;

	}

	/deep/ ._i {
		font-size: 30rpx !important;
		line-height: 1.5 !important;
	}

	.images {
		display: flex;
		margin-top: 40rpx;

		image {
			width: 210upx;
			height: 210upx;
			border-radius: 8upx;
			margin-bottom: 20upx;
		}
	}

	.detail-wrap {
		background: #fff;
		// #ifdef MP-WEIXIN
		min-height: 100vh;
		// #endif
		// #ifdef H5
		min-height: calc(100vh - 44px);
		// #endif
		padding: 1upx 24upx 40upx;

		.title {
			font-family: "PingFang SC Bold";
			color: #000;
			padding-top: 100rpx;
			font-size: 48rpx;
			font-weight: bold;
		}

		.information {
			margin: 40upx 0;

			image {
				width: 64upx;
				height: 64upx;
				margin-right: 20upx;
			}

			.left {
				image {
					border-radius: 50%;
				}
			}

			.names {
				.name {
					font-family: "PingFang SC Bold";
					// font-weight: 700;
					font-size: 18px;
					color: #080F18;
				}

				.time {
					font-family: "PingFang SC";
					font-size: 14px;
					color: #646464;
				}
			}

			.right {
				image {
					width: 44upx;
					height: 44upx;
				}
			}
		}
	}

	// 精选推荐
	.hot {
		margin-top: 40rpx;

		.hot-name {
			margin: 0 0 10rpx 0;
			font-weight: 700;
			font-size: 36rpx;
			color: #080F18;
		}

		.hot-item {
			.item-box {
				padding: 32rpx 24rpx;
				margin-bottom: 20rpx;
				border-radius: 16rpx;
				background: #fafafe;

				.item-left {
					margin-right: 40rpx;

					.item-left-title {
						font-weight: 700;
						font-size: 28rpx;
						color: #080F18;
					}

					.item-left-ping {
						margin-top: 40rpx;
						font-weight: 400;
						font-size: 24rpx;
						color: #646464;

						.t1 {
							margin-left: 16rpx;
						}
					}
				}

				.item-right {

					image {
						width: 226rpx;
						height: 160rpx;
						border-radius: 8rpx;
					}
				}
			}
		}
	}
</style>
<style lang="scss">
	.post {
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.7);
		position: fixed;
		top: 0upx;
		z-index: 10000;
		text-align: center;

		.wrapper {
			height: 1420upx;
			width: 610upx;
			// margin: 0 auto;
			margin-top: -150upx;

			// margin-top: 50upx;
		}
	}

	.tupian {
		width: 100%;
		height: 1360upx;
		// background-image: url('../../static/images/tutu3.png');
		background-size: 750upx 1360upx;
	}

	.cha {
		background-image: url('../../static/images/chacha.png');
		background-size: 80upx 80upx;
		position: relative;
		top: 40upx
	}

	.articcontent {
		line-height: 2;
		padding: 0px 20px;
		color: #333;
	}

	.artictitle {
		color: #000;
		font-weight: 500;
		padding: 15px 20px;
	}

	.bottom {
		display: flex;
		background-color: rgb(242, 242, 242);
		padding: 15px 20px;
	}

	.left {
		width: 50%;

		text-align: left;
	}

	.right {
		width: 50%;

		text-align: right;
		padding-top: 10px;
		// margin-left: 20px;
	}

	.top {
		padding-top: 10px;
		color: #767676;
	}

	.tip1 {

		background-color: rgb(245, 246, 248);
		margin: 15px 0px 15px 20px;
		padding: 5px 10px;
		color: #767676;
		font-size: 14rpx;

	}

	.top-title {
		display: flex;
		width: 200rpx;
		white-space: nowrap;
		align-items: center;

	}

	.numlist-name {

		width: 18%;
		font-size: 30rpx;
		color: #060606;
		font-weight: 800;
		margin-left: 10rpx;
	}

	.name-date {
		margin: 40rpx 0;
		text:first-of-type {
			margin-left: 0;
		}

		text {
			font-family: "PingFang SC Bold";
			font-size: 18px;
			color: #080F18;
			margin: 0 10rpx;
		}

		.date {
			font-family: "PingFang SC";
			font-size: 14px;
			color: #646464;
		}
	}
</style>
